#ifndef OLED_DISPLAY_H
#define OLED_DISPLAY_H

#include <Arduino.h>
#include "config.h"

#ifdef ARDUINO
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#endif

// Display configuration
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_I2C_ADDRESS 0x3C
#define OLED_RESET -1

// Display states
enum DisplayMode {
    DISPLAY_BOOT_LOGO,
    DISPLAY_BOOT_SEQUENCE,
    DISPLAY_LOADING,
    DISPLAY_FLIGHT_DATA,
    DISPLAY_ERROR,
    DISPLAY_OFF
};

struct DisplayData {
    DisplayMode currentMode = DISPLAY_BOOT_LOGO;
    uint32_t lastUpdate = 0;
    uint32_t bootStartTime = 0;
    uint8_t bootStep = 0;
    bool initialized = false;
};

extern DisplayData displayData;
extern bool oled_initialized;

#ifdef ARDUINO
extern Adafruit_SSD1306 display;
#endif

// Boot logo bitmap (128x64) - CanSat team logo
const unsigned char epd_bitmap_Screenshot_2025_09_27_at_2[] PROGMEM = {
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x80, 0x40, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x07, 0xff, 0x60, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xf0, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xff, 0xfc, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xff, 0xff, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0x80, 0x3f, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0x00, 0x3f, 0xff, 0xfc, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x3f, 0xfe, 0xd8, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x3f, 0xf8, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x7f, 0xe0, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0x80, 0x00, 0x01, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x02, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x04, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x30, 0x22, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0x80, 0x30, 0x40, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x1f, 0x80, 0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x07, 0xc0, 0x00, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x03, 0xc0, 0x01, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xf8, 0x01, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xfc, 0x03, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xfe, 0x3f, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xbf, 0xff, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03, 0xff, 0xef, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0xf7, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0xf7, 0xfe, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xc1, 0xfd, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff, 0x80, 0xff, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xfe, 0x00, 0xff, 0xe0, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xfc, 0x01, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xf8, 0x07, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xe0, 0x1f, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x07, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};

/**
 * Initialize OLED display
 */
bool initializeOLED() {
    logEvent("=== OLED Display Initialization ===");
    
#ifdef ARDUINO
    // Initialize display
    if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_I2C_ADDRESS)) {
        logEvent("✗ OLED Display FAILED");
        oled_initialized = false;
        return false;
    }
#endif
    
    oled_initialized = true;
    displayData.initialized = true;
    displayData.bootStartTime = millis();
    displayData.currentMode = DISPLAY_BOOT_LOGO;
    
    logEvent("✓ OLED Display OK (128x64)");
    return true;
}

/**
 * Display boot logo
 */
void displayBootLogo() {
#ifdef ARDUINO
    if (!oled_initialized) return;
    
    display.clearDisplay();
    display.drawBitmap(0, 0, epd_bitmap_Screenshot_2025_09_27_at_2, 128, 64, SSD1306_WHITE);
    
    // Add team name
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(35, 56);
    display.print("Team Brahmand");
    
    display.display();
#endif
}

/**
 * Display loading animation with progress
 */
void displayLoadingAnimation() {
#ifdef ARDUINO
    if (!oled_initialized) return;
    
    static uint32_t lastAnimUpdate = 0;
    static int animFrame = 0;
    
    if (millis() - lastAnimUpdate > 100) {  // Update every 100ms
        display.clearDisplay();
        
        // Title
        display.setTextSize(2);
        display.setTextColor(SSD1306_WHITE);
        display.setCursor(20, 10);
        display.print("CanSat");
        
        // Loading bar
        int barWidth = 100;
        int barHeight = 8;
        int barX = (SCREEN_WIDTH - barWidth) / 2;
        int barY = 35;
        
        // Progress based on boot time
        uint32_t bootTime = millis() - displayData.bootStartTime;
        int progress = constrain((bootTime * barWidth) / 10000, 0, barWidth);  // 10 second boot
        
        // Draw loading bar
        display.drawRect(barX, barY, barWidth, barHeight, SSD1306_WHITE);
        display.fillRect(barX + 1, barY + 1, progress - 1, barHeight - 2, SSD1306_WHITE);
        
        // Loading text
        display.setTextSize(1);
        display.setCursor(45, 50);
        display.print("VA");
        
        // Spinning indicator
        int centerX = SCREEN_WIDTH - 20;
        int centerY = 20;
        int radius = 8;
        
        for (int i = 0; i < 8; i++) {
            int alpha = (animFrame + i * 45) % 360;
            int x = centerX + (radius * cos(radians(alpha))) / 2;
            int y = centerY + (radius * sin(radians(alpha))) / 2;
            
            if (i < 4) {
                display.fillCircle(x, y, 1, SSD1306_WHITE);
            } else {
                display.drawCircle(x, y, 1, SSD1306_WHITE);
            }
        }
        
        display.display();
        
        animFrame += 30;
        lastAnimUpdate = millis();
    }
#endif
}

/**
 * Display boot sequence status
 */
void displayBootSequence() {
#ifdef ARDUINO
    if (!oled_initialized) return;
    
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    
    // Title
    display.setCursor(25, 0);
    display.print("CANSAT BOOT");
    
    display.drawLine(0, 10, SCREEN_WIDTH, 10, SSD1306_WHITE);
    
    // Boot steps
    const char* bootSteps[] = {
        "Init I2C Bus",
        "Init SPI Bus", 
        "Init Sensors",
        "Init LoRa Radio",
        "Init GPS Module",
        "Init SD Card",
        "Load BlackBox",
        "Start RTOS Tasks"
    };
    
    for (int i = 0; i < 8; i++) {
        display.setCursor(0, 12 + i * 7);
        
        if (i < displayData.bootStep) {
            display.print("[OK] ");
        } else if (i == displayData.bootStep) {
            display.print("[..] ");
        } else {
            display.print("[  ] ");
        }
        
        display.print(bootSteps[i]);
    }
    
    display.display();
#endif
}

/**
 * Display flight data dashboard
 */
void displayFlightData() {
#ifdef ARDUINO
    if (!oled_initialized) return;
    
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    
    // Flight state
    display.setCursor(0, 0);
    display.print("State: ");
    display.print(getStateName(currentFlightState));
    
    // Altitude and velocity
    display.setCursor(0, 10);
    display.print("Alt: ");
    display.print(telemetryData.altitude, 1);
    display.print("m");
    
    display.setCursor(70, 10);
    display.print("VS: ");
    display.print(telemetryData.verticalSpeed, 1);
    
    // Temperature and pressure
    display.setCursor(0, 20);
    display.print("Temp: ");
    display.print(telemetryData.temperature, 1);
    display.print("C");
    
    display.setCursor(70, 20);
    display.print("P: ");
    display.print(telemetryData.pressure / 100.0f, 0);
    
    // Battery and GPS
    display.setCursor(0, 30);
    display.print("Batt: ");
    display.print(telemetryData.batteryPercent, 0);
    display.print("%");
    
    display.setCursor(70, 30);
    display.print("Sats: ");
    display.print(telemetryData.gnssSatellites);
    
    // Gas sensors (if available)
    if (gasSensorData.sensors_ready) {
        display.setCursor(0, 40);
        display.print("CO2: ");
        display.print(gasSensorData.co2_ppm, 0);
        display.print("ppm");
        
        if (gasSensorData.gas_detected) {
            display.setCursor(0, 50);
            display.print("GAS ALERT!");
        }
    }
    
    // Status bar at bottom
    display.drawLine(0, 54, SCREEN_WIDTH, 54, SSD1306_WHITE);
    display.setCursor(0, 56);
    display.print("Pkt:");
    display.print(telemetryData.packetCount);
    
    display.setCursor(70, 56);
    display.print("T+");
    display.print(telemetryData.timeStamp, 0);
    display.print("s");
    
    display.display();
#endif
}

/**
 * Display error message
 */
void displayError(const String& errorMsg) {
#ifdef ARDUINO
    if (!oled_initialized) return;
    
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    
    // Error header
    display.setCursor(35, 0);
    display.print("ERROR");
    display.drawLine(0, 10, SCREEN_WIDTH, 10, SSD1306_WHITE);
    
    // Error message (word wrapped)
    display.setCursor(0, 15);
    
    // Simple word wrapping
    int lineY = 15;
    int charCount = 0;
    for (unsigned int i = 0; i < errorMsg.length(); i++) {
        if (charCount >= 21 || errorMsg.c_str()[i] == '\n') {  // 21 chars per line
            lineY += 8;
            charCount = 0;
            display.setCursor(0, lineY);
        }
        
        if (errorMsg.c_str()[i] != '\n') {
            display.print(errorMsg.c_str()[i]);
            charCount++;
        }
    }
    
    display.display();
#endif
}

/**
 * Update display based on current mode and system state
 */
void updateDisplay() {
    if (!oled_initialized || !displayData.initialized) return;
    
    uint32_t currentTime = millis();
    
    switch (displayData.currentMode) {
        case DISPLAY_BOOT_LOGO:
            displayBootLogo();
            // Show logo for 3 seconds
            if (currentTime - displayData.bootStartTime > 3000) {
                displayData.currentMode = DISPLAY_LOADING;
            }
            break;
            
        case DISPLAY_LOADING:
            displayLoadingAnimation();
            // Show loading for 10 seconds total boot time
            if (currentTime - displayData.bootStartTime > 10000) {
                displayData.currentMode = DISPLAY_BOOT_SEQUENCE;
            }
            break;
            
        case DISPLAY_BOOT_SEQUENCE:
            displayBootSequence();
            // Advance boot step periodically
            if (currentTime - displayData.lastUpdate > 1000) {
                displayData.bootStep++;
                displayData.lastUpdate = currentTime;
                
                if (displayData.bootStep >= 8) {
                    displayData.currentMode = DISPLAY_FLIGHT_DATA;
                }
            }
            break;
            
        case DISPLAY_FLIGHT_DATA:
            // Update flight data every 2 seconds
            if (currentTime - displayData.lastUpdate > 2000) {
                displayFlightData();
                displayData.lastUpdate = currentTime;
            }
            break;
            
        case DISPLAY_ERROR:
            // Error display - no automatic update
            break;
            
        case DISPLAY_OFF:
            // Display is off
            break;
    }
}

/**
 * Set display mode
 */
void setDisplayMode(DisplayMode mode) {
    displayData.currentMode = mode;
    displayData.lastUpdate = millis();
}

/**
 * Show error on display
 */
void showDisplayError(const String& errorMsg) {
    displayData.currentMode = DISPLAY_ERROR;
    displayError(errorMsg);
}

/**
 * Turn off display to save power
 */
void turnOffDisplay() {
#ifdef ARDUINO
    if (oled_initialized) {
        display.clearDisplay();
        display.display();
    }
#endif
    displayData.currentMode = DISPLAY_OFF;
}

#endif // OLED_DISPLAY_H